<div id="central-widget"></div>

<script>
(function () {
  const el = document.getElementById("central-widget");
  if (!el) return;

  const brand = { primary:"#6a11cb", secondary:"#2575fc", bg:"#0b0f1a", text:"#fff" };
  const chat = {
    webhookUrl: "https://infranodus.app.n8n.cloud/webhook/0a59eb8e-d075-45f5-b374-c8315877bc28/chat",
    showWelcomeScreen: false, defaultLanguage:"en",
    initialMessages: ["Talk to the Books of Dmitry Paranyushkin","What would you like to discuss?"],
    i18n: { title:"Interactive Assistant", subtitle:"What would you like to discuss?", footer:"", getStarted:"New Conversation", inputPlaceholder:"Type your messageâ€¦" }
  };
  const callUrl = "https://elevenlabs.io/app/talk-to?agent_id=agent_01jvx2jt9pf9vbs7k64s6dn50y";
  const agentId = (function(u){try{return new URL(u).searchParams.get("agent_id")||"";}catch{return ""}})(callUrl) || "agent_01jvx2jt9pf9vbs7k64s6dn50y";

  el.innerHTML = `
    <div style="width:min(900px,92vw);height:640px;margin:4rem auto;border-radius:16px;overflow:hidden;box-shadow:0 24px 60px rgba(0,0,0,.35);background:${brand.bg};color:${brand.text};">
      <div style="display:flex;align-items:center;gap:8px;padding:12px 14px;background:linear-gradient(90deg,${brand.primary},${brand.secondary});">
        <div style="font-weight:700">Interactive Assistant</div>
        <div style="flex:1"></div>
        <div id="tabs" style="display:flex;gap:8px;background:rgba(255,255,255,.12);padding:6px;border-radius:12px">
          <button id="tabText" style="border:0;border-radius:10px;padding:8px 12px;color:#fff;background:rgba(0,0,0,.18);font-weight:600;cursor:pointer">Text</button>
          <button id="tabVoice" style="border:0;border-radius:10px;padding:8px 12px;color:#fff;background:transparent;font-weight:600;cursor:pointer">Voice</button>
        </div>
      </div>
      <div id="stage" style="position:relative;height:calc(100% - 52px)">
        <div id="mount" style="position:absolute;inset:0;overflow:auto"></div>
        <div id="hint" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;opacity:.8">Choose Text or Voice above to start.</div>
      </div>
    </div>
  `;

  const mount = el.querySelector("#mount");
  const hint = el.querySelector("#hint");
  const tabText = el.querySelector("#tabText");
  const tabVoice = el.querySelector("#tabVoice");

  function clear() {
    const n8nChat = document.querySelector(".n8n-chat");
    if (n8nChat) n8nChat.remove();
    document.querySelectorAll("elevenlabs-convai").forEach(el => el.remove());
    document.querySelectorAll("script[data-injected='1']").forEach(s => s.remove());
    hint.style.display = "flex";
    tabText.style.background = "rgba(0,0,0,.18)";
    tabVoice.style.background = "transparent";
  }

  function loadText() {
    clear();
    hint.style.display = "none";

    // ensure n8n css present
    if (!document.querySelector('link[href*="@n8n/chat/dist/style.css"]')) {
      const link = document.createElement("link");
      link.rel="stylesheet";
      link.href="https://cdn.jsdelivr.net/npm/@n8n/chat/dist/style.css";
      document.head.appendChild(link);
    }
    const s = document.createElement("script");
    s.type = "module";
    s.dataset.injected="1";
    s.textContent = `
      import { createChat } from 'https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.bundle.es.js';
      createChat({
        webhookUrl: ${JSON.stringify(chat.webhookUrl)},
        showWelcomeScreen: ${JSON.stringify(chat.showWelcomeScreen)},
        defaultLanguage: ${JSON.stringify(chat.defaultLanguage)},
        initialMessages: ${JSON.stringify(chat.initialMessages)},
        i18n: { ${JSON.stringify(chat.defaultLanguage)}: {
          title:${JSON.stringify(chat.i18n.title)},
          subtitle:${JSON.stringify(chat.i18n.subtitle)},
          footer:${JSON.stringify(chat.i18n.footer)},
          getStarted:${JSON.stringify(chat.i18n.getStarted)},
          inputPlaceholder:${JSON.stringify(chat.i18n.inputPlaceholder)}
        } }
      });
    `;
    document.body.appendChild(s);
  }

  function loadVoice() {
    clear();
    hint.style.display = "none";
    tabText.style.background = "transparent";
    tabVoice.style.background = "rgba(0,0,0,.18)";

    const convai = document.createElement("elevenlabs-convai");
    convai.setAttribute("agent-id", agentId);
    convai.style.position = "absolute";
    convai.style.inset = "0";
    convai.style.width = "100%";
    convai.style.height = "100%";
    mount.appendChild(convai);

    const s = document.createElement("script");
    s.src = "https://unpkg.com/@elevenlabs/convai-widget-embed";
    s.async = true;
    s.dataset.injected = "1";
    document.body.appendChild(s);
  }

  // default to Text
  loadText();
  tabText.addEventListener("click", loadText);
  tabVoice.addEventListener("click", loadVoice);
})();
</script>
